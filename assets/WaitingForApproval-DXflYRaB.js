import{c as O,d as $,u as j,a as E,r as f,o as F,w as U,b as d,e as h,f as n,g as N,h as A,t as R,v as V,i as _,j as W,k as I,l as L,m as M,n as H,p as u,_ as J}from"./index-H4--sOdv.js";const m=O(),s={socket:null,cafeId:null,token:null,reconnectTimer:null},Y="wss://iisertvmcafe.work.gd";function q(r,l){return`${Y}/ws/order-control/${r}/?token=${l}`}function S(){s.reconnectTimer!==null&&(clearTimeout(s.reconnectTimer),s.reconnectTimer=null)}function C(r,l){if(!r||!l||s.socket&&s.socket.readyState===WebSocket.OPEN&&s.cafeId===r)return;z(),s.cafeId=r,s.token=l;const i=new WebSocket(q(r,l));s.socket=i,i.onopen=()=>{S(),m.emit("socket-open",null)},i.onmessage=c=>{try{const a=JSON.parse(c.data);a.type==="staging_update"&&m.emit("staging-update",a),a.type==="payment_update"&&m.emit("payment-update",a)}catch{}},i.onerror=()=>{i.close()},i.onclose=()=>{s.socket=null,m.emit("socket-close",null),!s.reconnectTimer&&s.cafeId&&s.token&&(s.reconnectTimer=setTimeout(()=>{C(s.cafeId,s.token)},3e3))}}function z(){S(),s.socket&&s.socket.close(),s.socket=null,s.cafeId=null,s.token=null}const G={class:"min-h-screen bg-[#FDFBF7] flex items-center justify-center p-6"},K={key:0,class:"text-center"},Q={key:1,class:"card"},X={key:2,class:"card w-full max-w-md"},Z=["disabled"],ee={key:3,class:"card"},te={key:4,class:"card"},ne={key:5,class:"card"},w="iiservithura@sbi",se=$({__name:"WaitingForApproval",setup(r){const l=j(),i=W(),c=String(l.params.stagingId),a=E(),b=f(!0),o=f("pending"),v=f(""),y=f(null),g=f(!1),p=t=>window.alert(t),T=async()=>{try{const t=await I.get(`/orders/staging/${c}/`,{params:{cafe:a.selectedCafeId}});o.value=t.data.status}catch{p("Couldn't load your order")}finally{b.value=!1}},x=()=>{!a.accessToken||!a.selectedCafeId||(C(a.selectedCafeId,a.accessToken),m.on("staging-update",t=>{`${t.order_id}`===c&&(o.value=t.stage)}),m.on("payment-update",t=>{`${t.order_id}`===c&&(o.value=t.payment_status==="verified"?"payment_verified":"payment_submitted")}),L(Number(c),a.accessToken,a.selectedCafeId),M.on("order-status",t=>{t.status==="payment_verified"&&(o.value="payment_verified",a.setLastStagingId(null)),t.status==="rejected"&&(o.value="rejected",H())}))},P=t=>{const e=t.target?.files?.[0];e&&(y.value=e)},B=async()=>{await navigator.clipboard.writeText(w),p("UPI ID copied")},D=async()=>{if(!v.value.trim()){p("Enter transaction ID");return}if(!y.value){p("Upload payment screenshot");return}g.value=!0;try{const t=new FormData;t.append("transaction_id",v.value),t.append("transaction_image",y.value),await I.post(`/orders/staging/${c}/submit-payment/`,t,{headers:{"Content-Type":"multipart/form-data"}}),o.value="payment_submitted",p("Payment submitted âœ¨")}catch{p("Payment upload failed")}finally{g.value=!1}};return F(()=>{T(),x()}),U(o,t=>{(t==="payment_verified"||t==="rejected")&&a.setLastStagingId(null)}),(t,e)=>(u(),d("div",G,[b.value?(u(),d("div",K,[...e[3]||(e[3]=[n("div",{class:"animate-spin text-4xl mb-4"},"â˜•",-1),N(" Loading your order... ",-1)])])):o.value==="pending"?(u(),d("div",Q,[...e[4]||(e[4]=[n("div",{class:"icon pulse"},"â³",-1),n("h2",null,"Checking with staff",-1),n("p",null,"Your order is being reviewed",-1)])])):o.value==="awaiting_payment"?(u(),d("div",X,[e[6]||(e[6]=n("h2",{class:"mb-4"},"Order Approved ðŸŽ‰",-1)),n("div",{class:"mb-4"},[e[5]||(e[5]=n("p",{class:"font-semibold"},"UPI ID",-1)),n("div",{class:"flex justify-between bg-[#F6F1EB] p-3 rounded"},[n("span",null,R(w)),n("button",{onClick:B,class:"btn-sm"},"Copy")])]),A(n("input",{"onUpdate:modelValue":e[0]||(e[0]=k=>v.value=k),placeholder:"Transaction ID",class:"input"},null,512),[[V,v.value]]),n("input",{type:"file",accept:"image/*",onChange:P,class:"mt-4"},null,32),n("button",{class:"btn mt-6",disabled:g.value,onClick:D}," Submit Payment ",8,Z)])):o.value==="payment_submitted"?(u(),d("div",ee,[...e[7]||(e[7]=[n("div",{class:"icon pulse"},"âŒ›",-1),n("h2",null,"Verifying payment",-1),n("p",null,"Please wait",-1)])])):o.value==="payment_verified"?(u(),d("div",te,[e[8]||(e[8]=n("div",{class:"icon success"},"âœ”",-1)),e[9]||(e[9]=n("h2",null,"Payment Confirmed",-1)),n("button",{class:"btn mt-4",onClick:e[1]||(e[1]=k=>_(i).replace("/"))}," Back to Home ")])):o.value==="rejected"?(u(),d("div",ne,[e[10]||(e[10]=n("div",{class:"icon error"},"âœ–",-1)),e[11]||(e[11]=n("h2",null,"Order Rejected",-1)),n("button",{class:"btn mt-4",onClick:e[2]||(e[2]=k=>_(i).replace("/"))}," Back to Home ")])):h("",!0)]))}}),oe=J(se,[["__scopeId","data-v-e1e29658"]]);export{oe as default};
